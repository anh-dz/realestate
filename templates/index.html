<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taipei Real Estate Analytics</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chart.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/tp.png') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <div class="container">
        <div class="header-container">
            <div>
                <h1>Taipei Real Estate Analytics</h1>
                <h1>Âè∞ÂåóÊàøÂú∞Áî¢ÂàÜÊûê</h1>
                <span class="record-count">Found <strong>{{ "{:,.0f}".format(total_count) }}</strong> properties available</span>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                
                <a href="{{ url_for('help_page') }}" class="btn btn-filter" style="background-color: #3b82f6;">üìò Help</a> 
                <a href="{{ url_for('add') }}" class="btn btn-filter" style="background-color: #28a745;">+ Add</a>
                <a href="{{ url_for('suggest') }}" class="btn btn-suggest">üí∞ Calculator</a>
                <button id="theme-toggle" class="btn btn-theme" title="Toggle Dark Mode">üåô</button>
            </div>
        </div>

        <form action="/" method="GET" class="filter-bar">
            <div class="filter-group"><label>District</label><select name="district"><option value="">All Districts</option>{% for d in districts %}<option value="{{ d['district_id'] }}" {% if selected_district|int == d['district_id'] %}selected{% endif %}>{{ d['district_name'] }}</option>{% endfor %}</select></div>
            <div class="filter-group"><label>Type</label><select name="building_type"><option value="">All Types</option>{% for b in building_types %}<option value="{{ b['building_type'] }}" {% if selected_type == b['building_type'] %}selected{% endif %}>{{ b['building_type'] }}</option>{% endfor %}</select></div>
            <div class="filter-group"><label>Material</label><select name="material" style="min-width: 130px;"><option value="">All Materials</option>{% for m in materials %}<option value="{{ m['building_materials'] }}" {% if selected_material == m['building_materials'] %}selected{% endif %}>{{ m['building_materials'] }}</option>{% endfor %}</select></div>
            <div class="filter-group"><label>Parking</label><select name="parking" style="min-width: 130px;"><option value="">All Options</option><option value="None" {% if selected_parking == 'None' %}selected{% endif %}>No Parking</option>{% for p in parking_types %}<option value="{{ p['parking_type'] }}" {% if selected_parking == p['parking_type'] %}selected{% endif %}>{{ p['parking_type'] }}</option>{% endfor %}</select></div>
            <div class="filter-group"><label>Balcony</label><select name="balcony" style="min-width: 100px;"><option value="">All</option><option value="yes" {% if selected_balcony == 'yes' %}selected{% endif %}>Yes</option><option value="no" {% if selected_balcony == 'no' %}selected{% endif %}>No</option></select></div>
            <div class="filter-group"><label>Price Per M2</label><div class="price-inputs"><input type="number" name="min_price" placeholder="Min" value="{{ min_price if min_price }}"><span class="price-separator">-</span><input type="number" name="max_price" placeholder="Max" value="{{ max_price if max_price }}"></div></div>
            <div>
                <button type="submit" class="btn btn-filter">Apply</button>
                <button class="btn btn-reset"><a href="/">Reset</a></button>
            </div>
        </form>

        <div class="table-wrapper">
            <div class="table-container">
                <table id="resultTable"> 
                    <thead>
                        <tr>
                            <th><a href="{{ url_for('index', sort_by='id', order='desc' if sort_by=='id' and order=='asc' else 'asc', page=1, district=selected_district, building_type=selected_type, material=selected_material, parking=selected_parking, balcony=selected_balcony, min_price=min_price, max_price=max_price) }}" class="{{ 'active' if sort_by == 'id' else '' }}">ID {% if sort_by == 'id' %}{{ '‚ñ≤' if order == 'asc' else '‚ñº' }}{% endif %}</a></th>
                            <th><a href="{{ url_for('index', sort_by='district', order='desc' if sort_by=='district' and order=='asc' else 'asc', page=1, district=selected_district, building_type=selected_type, material=selected_material, parking=selected_parking, balcony=selected_balcony) }}" class="{{ 'active' if sort_by == 'district' else '' }}">District {% if sort_by == 'district' %}{{ '‚ñ≤' if order == 'asc' else '‚ñº' }}{% endif %}</a></th>
                            <th>Address</th>
                            <th>Layout</th>
                            <th><a href="{{ url_for('index', sort_by='type', order='desc' if sort_by=='type' and order=='asc' else 'asc', page=1, district=selected_district, building_type=selected_type, material=selected_material, parking=selected_parking, balcony=selected_balcony) }}" class="{{ 'active' if sort_by == 'type' else '' }}">Type {% if sort_by == 'type' %}{{ '‚ñ≤' if order == 'asc' else '‚ñº' }}{% endif %}</a></th>
                            <th><a href="{{ url_for('index', sort_by='material', order='desc' if sort_by=='material' and order=='asc' else 'asc', page=1, district=selected_district, building_type=selected_type, material=selected_material, parking=selected_parking, balcony=selected_balcony) }}" class="{{ 'active' if sort_by == 'material' else '' }}">Material {% if sort_by == 'material' %}{{ '‚ñ≤' if order == 'asc' else '‚ñº' }}{% endif %}</a></th>
                            <th><a href="{{ url_for('index', sort_by='floor', order='desc' if sort_by=='floor' and order=='asc' else 'asc', page=1, district=selected_district, building_type=selected_type, material=selected_material, parking=selected_parking, balcony=selected_balcony) }}" class="{{ 'active' if sort_by == 'floor' else '' }}">Floor {% if sort_by == 'floor' %}{{ '‚ñ≤' if order == 'asc' else '‚ñº' }}{% endif %}</a></th>
                            <th>Nearby</th>
                            <th><a href="{{ url_for('index', sort_by='parking', order='desc' if sort_by=='parking' and order=='asc' else 'asc', page=1, district=selected_district, building_type=selected_type, material=selected_material, parking=selected_parking, balcony=selected_balcony) }}" class="{{ 'active' if sort_by == 'parking' else '' }}">Parking {% if sort_by == 'parking' %}{{ '‚ñ≤' if order == 'asc' else '‚ñº' }}{% endif %}</a></th>
                            <th><a href="{{ url_for('index', sort_by='price', order='desc' if sort_by=='price' and order=='asc' else 'asc', page=1, district=selected_district, building_type=selected_type, material=selected_material, parking=selected_parking, balcony=selected_balcony) }}" class="{{ 'active' if sort_by == 'price' else '' }}">Price/m¬≤ {% if sort_by == 'price' %}{{ '‚ñ≤' if order == 'asc' else '‚ñº' }}{% endif %}</a></th>
                            <th><a href="{{ url_for('index', sort_by='total', order='desc' if sort_by=='total' and order=='asc' else 'asc', page=1, district=selected_district, building_type=selected_type, material=selected_material, parking=selected_parking, balcony=selected_balcony) }}" class="{{ 'active' if sort_by == 'total' else '' }}">Total Price {% if sort_by == 'total' %}{{ '‚ñ≤' if order == 'asc' else '‚ñº' }}{% endif %}</a></th>
                            <th><a href="{{ url_for('index', sort_by='date', order='desc' if sort_by=='date' and order=='asc' else 'asc', page=1, district=selected_district, building_type=selected_type, material=selected_material, parking=selected_parking, balcony=selected_balcony) }}" class="{{ 'active' if sort_by == 'date' else '' }}">Date {% if sort_by == 'date' %}{{ '‚ñ≤' if order == 'asc' else '‚ñº' }}{% endif %}</a></th>
                            <th>Act</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if properties %}
                            {% for prop in properties %}
                            <tr>
                                <td class="col-id">#{{ prop['property_id'] }}</td>
                                <td>{{ prop['district_name'] }}</td>
                                <td class="address-cell" title="{{ prop['address'] }}">{{ prop['address'] }}</td>
                                <td><span class="layout-badge">{{ prop['room_count'] }} Rooms, {{ prop['hall_count'] }} Halls, {{ prop['bathroom_count'] }} Baths</span></td>
                                <td>{{ prop['building_type'] }}</td>
                                <td class="mat-badge">{{ prop['building_materials'] }}</td>
                                <td>{{ prop['floor_count'] }}F {% if prop['balcony'] %}<span title="Has Balcony" style="cursor:help">üå§</span>{% endif %}</td>
                                <td style="white-space: nowrap;">
                                    <span class="amenity-badge mrt {{ 'active' if prop['mrt_station_500m'] else '' }}" title="MRT Station < 500m">üöá</span>
                                    <span class="amenity-badge school {{ 'active' if prop['school_500m'] else '' }}" title="School < 500m">üéì</span>
                                    <span class="amenity-badge park {{ 'active' if prop['park_500m'] else '' }}" title="Park < 500m">üå≥</span>
                                    <span class="amenity-badge bus {{ 'active' if prop['bus_station_500m'] else '' }}" title="Bus Station < 500m">üöå</span>
                                    {% if prop['undesirable_500m'] %}<span class="amenity-badge undesirable active" title="Undesirable Facility < 500m">‚ö†Ô∏è</span>{% endif %}
                                </td>
                                <td>{% if prop['parking_type'] and prop['parking_type'] != 'nan' %}<span class="parking-badge">{{ prop['parking_type'] }}</span>{% else %}<span style="color:var(--text-muted)">-</span>{% endif %}</td>
                                <td>{{ "{:,.0f}".format(prop['price_per_sqm']) }}</td>
                                <td class="col-price">{{ "{:,.0f}".format(prop['price'] / 10000) }} <small style="color:var(--text-muted); font-weight:400">‰∏á</small></td>
                                <td style="color:var(--text-muted); font-size:0.9em">{{ prop['transaction_date'] }}</td>
                                <td>
                                    <a href="{{ url_for('edit', id=prop['property_id']) }}" class="action-btn btn-edit" title="Edit">‚úèÔ∏è</a>
                                    <form action="{{ url_for('delete', id=prop['property_id']) }}" method="POST" onsubmit="return confirm('Delete ID #{{ prop['property_id'] }}?');" style="margin: 0;"><button type="submit" class="action-btn btn-delete" title="Delete">üóë</button></form>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr><td colspan="13" style="text-align: center; padding: 40px; color: var(--text-muted);">No properties found matching your criteria.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="pagination-container">
            <div class="pagination-pages">
                {% if page > 1 %}<a href="{{ url_for('index', page=page-1, district=selected_district, building_type=selected_type, material=selected_material, parking=selected_parking, balcony=selected_balcony, min_price=min_price, max_price=max_price, sort_by=sort_by, order=order) }}" class="btn-page">‚Üê</a>{% endif %}
                {% for p in page_range %}
                    {% if p == '...' %}<span class="dots">...</span>{% else %}<a href="{{ url_for('index', page=p, district=selected_district, building_type=selected_type, material=selected_material, parking=selected_parking, balcony=selected_balcony, min_price=min_price, max_price=max_price, sort_by=sort_by, order=order) }}" class="btn-page {{ 'active' if p == page else '' }}">{{ p }}</a>{% endif %}
                {% endfor %}
                {% if page < total_pages %}<a href="{{ url_for('index', page=page+1, district=selected_district, building_type=selected_type, material=selected_material, parking=selected_parking, balcony=selected_balcony, min_price=min_price, max_price=max_price, sort_by=sort_by, order=order) }}" class="btn-page">‚Üí</a>{% endif %}
            </div>
            <form action="/" method="GET" class="quick-jump">
                <input type="hidden" name="district" value="{{ selected_district or '' }}">
                <input type="hidden" name="building_type" value="{{ selected_type or '' }}">
                <input type="hidden" name="material" value="{{ selected_material or '' }}">
                <input type="hidden" name="parking" value="{{ selected_parking or '' }}">
                <input type="hidden" name="balcony" value="{{ selected_balcony or '' }}">
                <input type="hidden" name="min_price" value="{{ min_price or '' }}">
                <input type="hidden" name="max_price" value="{{ max_price or '' }}">
                <input type="hidden" name="sort_by" value="{{ sort_by }}">
                <input type="hidden" name="order" value="{{ order }}">
                <span style="font-size:0.85em; margin-left: 5px; color: var(--text-muted);">Go to page</span>
                <input type="number" name="page" min="1" max="{{ total_pages }}" placeholder="#" required><button type="submit" class="btn-go">Go</button>
            </form>
        </div>

        {% if chart_labels and chart_values %}
        <div class="chart-container">
            <h2 class="chart-title">üìä Average Property Price by District (TWD/m¬≤)</h2>
            <div style="position: relative; height: 400px; width: 100%;">
                <canvas id="districtPriceChart"></canvas>
            </div>
        </div>
        {% endif %}

    </div>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
        let districtPriceChart = null;
        let chartDataConfig = null;

        function initChart() {
            {% if chart_labels and chart_values %}
                const ctx = document.getElementById('districtPriceChart');
                if (!ctx) return;

                const context2d = ctx.getContext('2d');
                
                const style = getComputedStyle(document.body);
                const primaryColor = style.getPropertyValue('--primary').trim();
                const textColor = style.getPropertyValue('--text-main').trim();
                const gridColor = style.getPropertyValue('--border').trim();

                const gradient = context2d.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, primaryColor); 
                gradient.addColorStop(1, primaryColor + '40'); 

                chartDataConfig = {
                    labels: {{ chart_labels | tojson }},
                    datasets: [{
                        label: 'Avg Price/m¬≤',
                        data: {{ chart_values | tojson }},
                        backgroundColor: gradient, 
                        hoverBackgroundColor: primaryColor,
                        borderColor: 'transparent',
                        borderWidth: 0,
                        borderRadius: 8, 
                        borderSkipped: false, 
                        barPercentage: 0.6, 
                        categoryPercentage: 0.8
                    }]
                };

                Chart.defaults.font.family = "'Inter', sans-serif";
                Chart.defaults.color = textColor;

                if (districtPriceChart) {
                    districtPriceChart.destroy();
                }

                districtPriceChart = new Chart(context2d, {
                    type: 'bar',
                    data: chartDataConfig,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 1000,
                            easing: 'easeOutQuart'
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: gridColor,
                                    borderDash: [5, 5], 
                                    drawBorder: false, 
                                },
                                ticks: { 
                                    color: textColor,
                                    font: { size: 11 },
                                    padding: 10,
                                    callback: function(value) { 
                                        if (value >= 1000000) return (value/1000000).toFixed(1) + 'M';
                                        if (value >= 1000) return (value/1000).toFixed(0) + 'k';
                                        return value; 
                                    } 
                                },
                                border: { display: false } 
                            },
                            x: {
                                grid: { display: false, drawBorder: false },
                                ticks: { color: textColor, font: { size: 12, weight: '500' } },
                                border: { display: false }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(30, 41, 59, 0.9)', 
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                padding: 12,
                                cornerRadius: 8,
                                displayColors: false, 
                                callbacks: {
                                    title: function(context) { return context[0].label; },
                                    label: function(context) { return context.parsed.y.toLocaleString() + ' TWD/m¬≤'; }
                                }
                            }
                        }
                    }
                });
            {% endif %}
        }

        document.addEventListener("DOMContentLoaded", initChart);
    </script>
</body>
</html>